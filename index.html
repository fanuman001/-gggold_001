<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger v5.0</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: sans-serif; background: var(--bg); color: #fff; padding: 15px; margin: 0; }
        .card { background: var(--card); padding: 18px; border-radius: 20px; margin-bottom: 12px; border: 1px solid var(--border); }
        h2 { color: var(--gold); margin: 0 0 12px 0; font-size: 16px; border-left: 4px solid var(--gold); padding-left: 10px; }
        select, input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .share-btn { padding: 12px 5px; background: #161b22; border: 1px solid #444; border-radius: 8px; text-align: center; font-size: 12px; cursor: pointer; color: var(--gray); }
        .share-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(0, 210, 255, 0.1); font-weight: bold; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        #note-preview { font-size: 12px; color: #00ff00; background: #000; padding: 10px; border-radius: 8px; min-height: 40px; border: 1px solid #333; margin-bottom: 10px; }
        .settle-item { background: rgba(46, 213, 115, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--green); }
    </style>
</head>
<body>

<div class="card">
    <h2>1. è®€å–æ­·å²çµå–® (description)</h2>
    <select id="history-select" onchange="previewData()"></select>
    <div id="note-preview">è«‹é¸æ“‡ä¸€ç­†ã€ŒğŸ’° çµå–®ã€ç´€éŒ„</div>
    <button class="btn-main" style="background:var(--gold); color:#000;" onclick="importData()">ğŸ“¥ åŒ¯å…¥çµå–®é‡‘é¡</button>
</div>

<div class="card">
    <h2>2. ç”Ÿæ´»é›œæ”¯åˆ†æ”¤ (æ‰€æœ‰äºº)</h2>
    <select id="payer-id"></select>
    <input type="number" id="pay-amt" placeholder="è¼¸å…¥ç¸½é‡‘é¡ (å¦‚ï¼šé£²æ–™1000)" inputmode="decimal">
    <div id="share-grid" class="share-grid"></div>
    <button class="btn-main" style="background:var(--green); color:#000;" onclick="submitExpense()">âœ… ç¢ºèªè¨˜å¸³</button>
</div>

<div class="card">
    <h2>3. æœ€çµ‚æ¸…ç®—åˆ†æ</h2>
    <div id="ledger-list" style="margin-bottom:15px;"></div>
    <button class="btn-main" style="background:var(--blue); color:#000;" onclick="analyzeMoney()">ğŸ”„ åŸ·è¡Œè‡ªå‹•é‚„éŒ¢æç¤º</button>
    <div id="analyze-results" style="margin-top:15px;"></div>
</div>

<button class="btn-main" style="background:none; border:1px solid var(--red); color:var(--red); margin: 20px 0 50px 0;" onclick="clearAllData()">ğŸ§¹ çµå¸³å®Œæˆï¼šä¸€éµæ­¸é›¶è³‡æ–™åº«</button>

<script>
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let players = [], historyList = [];

async function init() {
    try {
        const [pRes, hRes] = await Promise.all([
            fetch(`${API_URL}/players?select=*`, { headers: HEADERS }),
            fetch(`${API_URL}/history?select=*&order=created_at.desc&limit=20`, { headers: HEADERS })
        ]);
        players = await pRes.json();
        historyList = await hRes.json();
        render();
    } catch (e) { alert("è®€å–å¤±æ•—"); }
}

function render() {
    // 1. æ­·å²ä¸‹æ‹‰ï¼šæ¨™è¨»å“ªäº›æ˜¯çµå–®
    const hSelect = document.getElementById('history-select');
    hSelect.innerHTML = '<option value="">-- é¸æ“‡ç´€éŒ„ --</option>' + 
        historyList.map((h, i) => {
            const isSettlement = h.description && h.description.includes('ğŸ’°');
            return `<option value="${i}">${isSettlement ? 'âœ… ' : ''}${new Date(h.created_at).toLocaleTimeString()} - ${h.description.substring(0,15)}</option>`;
        }).join('');

    // 2. å¢ŠéŒ¢äººèˆ‡åˆ†æ”¤äºº
    document.getElementById('payer-id').innerHTML = players.map(p => `<option value="${p.id}">${p.name.replace('OFF_','')}</option>`).join('');
    document.getElementById('share-grid').innerHTML = players.map(p => `<div class="share-btn" data-id="${p.id}" onclick="this.classList.toggle('active')">${p.name.replace('OFF_','')}</div>`).join('');

    // 3. å‚µå‹™æ¸…å–®
    document.getElementById('ledger-list').innerHTML = players.filter(p => Math.abs(p.debt||0)>0.1).map(p => `
        <div class="ledger-row"><span>${p.name.replace('OFF_','')}</span><b>${Math.round(p.debt)}</b></div>`).join('');
}

function previewData() {
    const idx = document.getElementById('history-select').value;
    const preview = document.getElementById('note-preview');
    if(idx === "") { preview.innerText = "è«‹é¸æ“‡ç´€éŒ„"; return; }
    preview.innerText = historyList[idx].description || "ç„¡å…§å®¹";
}

async function importData() {
    const idx = document.getElementById('history-select').value;
    if(idx === "") return alert("è«‹å…ˆé¸å–çµå–®");
    let desc = historyList[idx].description || "";
    
    // å»é™¤ "ğŸ’° çµå–®ï¼š" å‰ç¶´
    desc = desc.replace('ğŸ’° çµå–®ï¼š', '').replace('ğŸ’° çµå–®:', '');
    
    if(!confirm("ç¢ºå®šåŒ¯å…¥é‡‘é¡ï¼Ÿ")) return;

    const parts = desc.split('|');
    for(let pStr of parts) {
        const pair = pStr.split(':');
        if(pair.length < 2) continue;
        const n = pair[0].trim();
        const a = parseFloat(pair[1].trim());

        // åŒ¹é…çƒå“¡ï¼šåå­—åŒ…å«åœ¨è³‡æ–™åº«åç¨±å…§
        const target = players.find(p => p.name.includes(n));
        if(target && !isNaN(a)) {
            await fetch(`${API_URL}/players?id=eq.${target.id}`, {
                method: 'PATCH',
                headers: HEADERS,
                body: JSON.stringify({ debt: (target.debt || 0) + a })
            });
        }
    }
    alert("åŒ¯å…¥æˆåŠŸï¼");
    init();
}

async function submitExpense() {
    const pId = document.getElementById('payer-id').value;
    const amt = parseFloat(document.getElementById('pay-amt').value);
    const selected = Array.from(document.querySelectorAll('.share-btn.active')).map(el => el.dataset.id);
    if(!amt || selected.length === 0) return alert("è³‡è¨Šä¸è¶³");
    const per = amt / selected.length;
    for(let p of players) {
        let diff = 0;
        if(p.id == pId) diff += amt;
        if(selected.includes(String(p.id))) diff -= per;
        if(Math.abs(diff) > 0.1) await fetch(`${API_URL}/players?id=eq.${p.id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify({ debt: (p.debt||0) + diff }) });
    }
    document.getElementById('pay-amt').value = '';
    init();
}

function analyzeMoney() {
    let d = players.filter(p => Math.abs(p.debt||0)>0.5).map(p => ({name:p.name.replace('OFF_',''), amount:Math.round(p.debt)}));
    let r = d.filter(x => x.amount > 0).sort((a,b)=>b.amount-a.amount);
    let p = d.filter(x => x.amount < 0).map(x => ({...x, amount:Math.abs(x.amount)})).sort((a,b)=>b.amount-a.amount);
    let res = [], i=0, j=0;
    while(i<p.length && j<r.length) {
        let amt = Math.min(p[i].amount, r[j].amount);
        res.push(`<div class="settle-item"><b>${p[i].name}</b> â” çµ¦ <b>${r[j].name}</b> : <span style="font-size:20px; font-weight:900; color:var(--gold);">$${amt}</span></div>`);
        p[i].amount-=amt; r[j].amount-=amt;
        if(p[i].amount===0) i++; if(r[j].amount===0) j++;
    }
    document.getElementById('analyze-results').innerHTML = res.length > 0 ? res.join('') : "å¸³ç›®å·²æ¸…ã€‚";
}

async function clearAllData() {
    if(!confirm("ç¢ºå®šå…¨é«”æ­¸é›¶ï¼Ÿ")) return;
    for(let p of players) {
        await fetch(`${API_URL}/players?id=eq.${p.id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify({ debt: 0, money: 0 }) });
    }
    alert("å…¨é«”æ­¸é›¶å®Œæˆï¼");
    init();
}

init();
</script>
</body>
</html>


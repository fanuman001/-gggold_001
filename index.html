<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger çµç®—ä¸­å¿ƒ</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; }
        .card { background: var(--card); padding: 18px; border-radius: 18px; margin-bottom: 12px; border: 1px solid var(--border); }
        h2 { color: var(--gold); margin: 0 0 12px 0; font-size: 16px; border-left: 4px solid var(--gold); padding-left: 10px; }
        select, input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .share-btn { padding: 12px 5px; background: #161b22; border: 1px solid #444; border-radius: 8px; text-align: center; font-size: 12px; cursor: pointer; color: var(--gray); transition: 0.2s; }
        .share-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(0, 210, 255, 0.1); font-weight: bold; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px; }
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        .settle-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--green); }
    </style>
</head>
<body>

<div class="card">
    <h2>1. è®€å–éŠæˆ²çµå–® (æ­·å²ç´€éŒ„)</h2>
    <select id="history-select" onchange="previewNote()"></select>
    <div id="note-preview" style="font-size:11px; color:var(--gray); margin-bottom:10px; background:#000; padding:8px; border-radius:5px; min-height:40px; white-space: pre-wrap;">å°šæœªé¸æ“‡è¨‚å–®</div>
    <button class="btn-main" style="background:var(--gold); color:#000;" onclick="importHistory()">åŒ¯å…¥çµå–®é‡‘é¡</button>
</div>

<div class="card">
    <h2>2. ç”Ÿæ´»é›œæ”¯åˆ†æ”¤ (æ‰€æœ‰äºº)</h2>
    <select id="payer-id"></select>
    <input type="number" id="pay-amt" placeholder="è¼¸å…¥ç¸½é‡‘é¡" inputmode="decimal">
    <div id="share-grid" class="share-grid"></div>
    <button class="btn-main" style="background:var(--green); color:#000;" onclick="submitExpense()">ç¢ºèªåˆ†æ”¤è¨˜å¸³</button>
</div>

<div class="card">
    <h2>3. æœ€çµ‚è‡ªå‹•åˆ†é… (è¨ˆç®—é‚„éŒ¢)</h2>
    <div id="ledger-list" style="margin-bottom:15px;"></div>
    <button class="btn-main" style="background:var(--blue); color:#000;" onclick="analyzeMoney()">ğŸ”„ åŸ·è¡Œè‡ªå‹•åˆ†æ</button>
    <div id="analyze-results" style="margin-top:15px;"></div>
</div>

<button class="btn-main" style="background:none; border:1px solid var(--red); color:var(--red); margin-top:20px; margin-bottom:50px;" onclick="clearAllData()">ğŸ§¹ çµå¸³å®Œæˆï¼šä¸€éµæ­¸é›¶è³‡æ–™åº«</button>

<script>
// --- è«‹å‹™å¿…ç¢ºèªé€™å…©è¡Œæ­£ç¢º ---
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let players = [];
let historyList = [];

async function init() {
    try {
        const [pRes, hRes] = await Promise.all([
            fetch(`${API_URL}/players?select=*`, { headers: HEADERS }),
            fetch(`${API_URL}/history?select=*&order=created_at.desc&limit=15`, { headers: HEADERS })
        ]);
        
        if (!pRes.ok || !hRes.ok) throw new Error("API å›å‚³éŒ¯èª¤");

        players = await pRes.json();
        historyList = await hRes.json();
        
        renderUI();
    } catch (e) { 
        console.error(e);
        alert("âŒ åˆå§‹åŒ–å¤±æ•—ï¼šè«‹æª¢æŸ¥ API è¨­å®šæˆ–ç¶²è·¯ã€‚"); 
    }
}

function renderUI() {
    // 1. æ­·å²è¨‚å–®ï¼šå¢åŠ å®‰å…¨æª¢æŸ¥ (h.note || "")
    const hSelect = document.getElementById('history-select');
    hSelect.innerHTML = '<option value="">-- é¸æ“‡æ­·å²çµå–® --</option>' + 
        historyList.map((h, i) => {
            const notePreview = (h.note || "ç„¡å…§å®¹").substring(0, 15);
            return `<option value="${i}">${new Date(h.created_at).toLocaleTimeString()} - ${notePreview}...</option>`;
        }).join('');

    // 2. å¢ŠéŒ¢äºº
    document.getElementById('payer-id').innerHTML = players.map(p => 
        `<option value="${p.id}">${p.name.replace('OFF_','')}</option>`).join('');

    // 3. æˆå“¡å‹¾é¸
    document.getElementById('share-grid').innerHTML = players.map(p => {
        const cleanName = p.name.replace('OFF_','');
        return `<div class="share-btn" data-id="${p.id}" onclick="this.classList.toggle('active')">${cleanName}</div>`;
    }).join('');

    // 4. ç¸½å‚µå‹™åˆ—è¡¨
    document.getElementById('ledger-list').innerHTML = players
        .filter(p => Math.abs(p.debt || 0) > 0.1)
        .map(p => `
            <div class="ledger-row">
                <span>${p.name.replace('OFF_','')}</span>
                <b style="color:${p.debt >= 0 ? 'var(--green)' : 'var(--red)'}">${Math.round(p.debt)}</b>
            </div>
        `).join('');
}

function previewNote() {
    const idx = document.getElementById('history-select').value;
    const preview = document.getElementById('note-preview');
    preview.innerText = (idx !== "" && historyList[idx]) ? historyList[idx].note : "å°šæœªé¸æ“‡è¨‚å–®";
}

async function importHistory() {
    const idx = document.getElementById('history-select').value;
    if(idx === "" || !historyList[idx].note) return alert("è«‹é¸æ“‡æœ‰æ•ˆè¨‚å–®");
    const note = historyList[idx].note;
    
    if(!confirm("ç¢ºå®šåŒ¯å…¥æ­¤ç­†çµå–®ï¼Ÿ")) return;

    const parts = note.split('|');
    for(let pStr of parts) {
        const pair = pStr.split(':');
        if(pair.length < 2) continue;
        const n = pair[0].trim();
        const a = parseFloat(pair[1].trim());

        const target = players.find(p => p.name.includes(n));
        if(target) await patch(target.id, { debt: (target.debt || 0) + a });
    }
    alert("åŒ¯å…¥å®Œæˆï¼");
    init();
}

async function submitExpense() {
    const pId = document.getElementById('payer-id').value;
    const amt = parseFloat(document.getElementById('pay-amt').value);
    const selected = Array.from(document.querySelectorAll('.share-btn.active')).map(el => el.dataset.id);

    if(!amt || selected.length === 0) return alert("è«‹è¼¸å…¥é‡‘é¡ä¸¦å‹¾é¸åˆ†æ”¤äºº");

    const perShare = amt / selected.length;
    for(let p of players) {
        let diff = 0;
        if(p.id == pId) diff += amt;
        if(selected.includes(String(p.id))) diff -= perShare;
        if(Math.abs(diff) > 0.1) await patch(p.id, { debt: (p.debt || 0) + diff });
    }
    document.getElementById('pay-amt').value = '';
    init();
}

function analyzeMoney() {
    let data = players.filter(p => Math.abs(p.debt || 0) > 0.5)
                      .map(p => ({ name: p.name.replace('OFF_',''), amount: Math.round(p.debt) }));
    
    let receivers = data.filter(d => d.amount > 0).sort((a,b) => b.amount - a.amount);
    let payers = data.filter(d => d.amount < 0).map(d => ({...d, amount: Math.abs(d.amount)})).sort((a,b) => b.amount - a.amount);

    let results = [];
    let i=0, j=0;
    while(i < payers.length && j < receivers.length) {
        let amt = Math.min(payers[i].amount, receivers[j].amount);
        results.push(`<div class="settle-item"><b>${payers[i].name}</b> â” çµ¦ â” <b>${receivers[j].name}</b> ï¼š <span style="font-size:20px; font-weight:900; color:var(--gold);">$${Math.round(amt)}</span></div>`);
        payers[i].amount -= amt; receivers[j].amount -= amt;
        if(payers[i].amount === 0) i++;
        if(receivers[j].amount === 0) j++;
    }
    document.getElementById('analyze-results').innerHTML = results.length > 0 ? results.join('') : "å¸³ç›®å·²å¹³è¡¡ã€‚";
}

async function clearAllData() {
    if(!confirm("âš ï¸ çµå¸³å®Œæˆï¼Ÿé€™æœƒæ¸…ç©ºè³‡æ–™åº«æ‰€æœ‰äººçš„é¤˜é¡èˆ‡å‚µå‹™ã€‚")) return;
    for(let p of players) await patch(p.id, { money: 0, debt: 0 });
    alert("è³‡æ–™åº«å·²æ¸…é›¶ï¼");
    init();
}

async function patch(id, data) {
    return fetch(`${API_URL}/players?id=eq.${id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify(data) });
}

init();
</script>
</body>
</html>


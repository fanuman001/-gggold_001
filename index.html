<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger çµç®—ä¸­å¿ƒ</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; }
        .card { background: var(--card); padding: 18px; border-radius: 18px; margin-bottom: 12px; border: 1px solid var(--border); }
        h2 { color: var(--gold); margin: 0 0 12px 0; font-size: 16px; border-left: 4px solid var(--gold); padding-left: 10px; }
        
        select, input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        
        /* æˆå“¡å‹¾é¸å€ */
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .share-btn { padding: 12px 5px; background: #161b22; border: 1px solid #444; border-radius: 8px; text-align: center; font-size: 12px; cursor: pointer; color: var(--gray); transition: 0.2s; }
        .share-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(0, 210, 255, 0.1); font-weight: bold; }
        
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px; }
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        .settle-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--green); }
    </style>
</head>
<body>

<div class="card">
    <h2>1. è®€å–éŠæˆ²çµå–® (å¾æ­·å²ç´€éŒ„)</h2>
    <select id="history-select" onchange="previewNote()"></select>
    <div id="note-preview" style="font-size:11px; color:var(--gray); margin-bottom:10px; background:#000; padding:8px; border-radius:5px; min-height:20px;">å°šæœªé¸æ“‡è¨‚å–®</div>
    <button class="btn-main" style="background:var(--gold); color:#000;" onclick="importHistory()">åŒ¯å…¥çµå–®é‡‘é¡</button>
</div>

<div class="card">
    <h2>2. ç”Ÿæ´»é›œæ”¯åˆ†æ”¤ (å¯é¸æ‰€æœ‰äºº)</h2>
    <select id="payer-id"></select>
    <input type="number" id="pay-amt" placeholder="è¼¸å…¥ç¸½é‡‘é¡ (ä¾‹å¦‚é£²æ–™éŒ¢)" inputmode="decimal">
    <div style="font-size:12px; color:var(--gray); margin-bottom:8px;">èª°è¦åˆ†æ”¤ï¼Ÿ(é»æ“Šå‹¾é¸)</div>
    <div id="share-grid" class="share-grid"></div>
    <button class="btn-main" style="background:var(--green); color:#000;" onclick="submitExpense()">ç¢ºèªè¨˜å¸³</button>
</div>

<div class="card">
    <h2>3. æœ€çµ‚è‡ªå‹•åˆ†é… (èª°è©²çµ¦èª°éŒ¢)</h2>
    <div id="ledger-list" style="margin-bottom:15px;"></div>
    <button class="btn-main" style="background:var(--blue); color:#000;" onclick="analyzeMoney()">ğŸ”„ åŸ·è¡Œè‡ªå‹•åˆ†æ</button>
    <div id="analyze-results" style="margin-top:15px;"></div>
</div>

<button class="btn-main" style="background:none; border:1px solid var(--red); color:var(--red); margin-top:20px; margin-bottom:50px;" onclick="clearAllData()">ğŸ§¹ çµå¸³å®Œæˆï¼šä¸€éµæ­¸é›¶è³‡æ–™åº«</button>

<script>
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let players = [];
let historyList = [];

async function init() {
    try {
        const [pRes, hRes] = await Promise.all([
            fetch(`${API_URL}/players?select=*`, { headers: HEADERS }),
            fetch(`${API_URL}/history?select=*&order=created_at.desc&limit=15`, { headers: HEADERS })
        ]);
        players = await pRes.json();
        historyList = await hRes.json();
        
        if (players.length === 0) alert("è³‡æ–™åº«å…§ç„¡æˆå“¡ï¼Œè«‹æª¢æŸ¥ Supabase");
        renderUI();
    } catch (e) { alert("é€£ç·šå¤±æ•—ï¼š" + e); }
}

function renderUI() {
    // 1. æ­·å²è¨‚å–®
    const hSelect = document.getElementById('history-select');
    hSelect.innerHTML = '<option value="">-- é¸æ“‡ä¸€ç­†ç¢ºå®šçµå–® --</option>' + 
        historyList.map((h, i) => `<option value="${i}">${new Date(h.created_at).toLocaleString().split(' ')[1]} - ${h.note.substring(0,15)}...</option>`).join('');

    // 2. å¢ŠéŒ¢äºº (æ‰€æœ‰äºº)
    const pSelect = document.getElementById('payer-id');
    pSelect.innerHTML = players.map(p => `<option value="${p.id}">${p.name.replace('OFF_','')}</option>`).join('');

    // 3. åˆ†æ”¤æˆå“¡å‹¾é¸å€ (é€™æ˜¯ä½ æ²’çœ‹åˆ°æˆå“¡çš„åœ°æ–¹ï¼Œç¾åœ¨å¼·åˆ¶å¾ªç’°æ‰€æœ‰ players)
    const sGrid = document.getElementById('share-grid');
    sGrid.innerHTML = players.map(p => {
        const cleanName = p.name.replace('OFF_','');
        return `<div class="share-btn" data-id="${p.id}" onclick="this.classList.toggle('active')">${cleanName}</div>`;
    }).join('');

    // 4. é¡¯ç¤ºç›®å‰æ¯å€‹äººçš„ç¸½å‚µå‹™
    const lList = document.getElementById('ledger-list');
    lList.innerHTML = players.filter(p => Math.abs(p.debt || 0) > 0.1).map(p => `
        <div class="ledger-row">
            <span>${p.name.replace('OFF_','')}</span>
            <b style="color:${p.debt >= 0 ? 'var(--green)' : 'var(--red)'}">${Math.round(p.debt)}</b>
        </div>
    `).join('');
}

function previewNote() {
    const idx = document.getElementById('history-select').value;
    document.getElementById('note-preview').innerText = idx !== "" ? historyList[idx].note : "å°šæœªé¸æ“‡è¨‚å–®";
}

// åŒ¯å…¥æ­·å²è¨‚å–®é‚è¼¯
async function importHistory() {
    const idx = document.getElementById('history-select').value;
    if(idx === "") return alert("è«‹å…ˆé¸æ“‡è¨‚å–®");
    const note = historyList[idx].note;
    
    if(!confirm("ç¢ºå®šåŒ¯å…¥é€™ç­†çµå–®é‡‘é¡å—ï¼Ÿ")) return;

    // è§£ææ ¼å¼ "åå­—:é‡‘é¡ | åå­—:é‡‘é¡"
    const parts = note.split('|');
    for(let pStr of parts) {
        const pair = pStr.split(':');
        if(pair.length < 2) continue;
        const n = pair[0].trim();
        const a = parseFloat(pair[1].trim());

        // æ¨¡ç³ŠåŒ¹é…ï¼šåªè¦åå­—åŒ…å«åœ¨è³‡æ–™åº«åç¨±å…§å³å¯ (ä¾‹å¦‚ "ç§‰è»’" åŒ¹é… "hsuanç§‰è»’")
        const target = players.find(p => p.name.includes(n));
        if(target) {
            await patch(target.id, { debt: (target.debt || 0) + a });
        }
    }
    alert("åŒ¯å…¥å®Œæˆï¼");
    init();
}

// é›œæ”¯åˆ†æ”¤é‚è¼¯
async function submitExpense() {
    const pId = document.getElementById('payer-id').value;
    const amt = parseFloat(document.getElementById('pay-amt').value);
    const selected = Array.from(document.querySelectorAll('.share-btn.active')).map(el => el.dataset.id);

    if(!amt || selected.length === 0) return alert("è«‹è¼¸å…¥é‡‘é¡ä¸¦å‹¾é¸åˆ†æ”¤äºº");

    const perShare = amt / selected.length;
    for(let p of players) {
        let diff = 0;
        if(p.id == pId) diff += amt;
        if(selected.includes(String(p.id))) diff -= perShare;
        if(Math.abs(diff) > 0.1) await patch(p.id, { debt: (p.debt || 0) + diff });
    }
    document.getElementById('pay-amt').value = '';
    init();
}

// è‡ªå‹•åˆ†æï¼šèª°è©²çµ¦èª°éŒ¢
function analyzeMoney() {
    let data = players.filter(p => Math.abs(p.debt || 0) > 0.5)
                      .map(p => ({ name: p.name.replace('OFF_',''), amount: Math.round(p.debt) }));
    
    let receivers = data.filter(d => d.amount > 0).sort((a,b) => b.amount - a.amount);
    let payers = data.filter(d => d.amount < 0).map(d => ({...d, amount: Math.abs(d.amount)})).sort((a,b) => b.amount - a.amount);

    let results = [];
    let i=0, j=0;
    while(i < payers.length && j < receivers.length) {
        let amt = Math.min(payers[i].amount, receivers[j].amount);
        results.push(`<div class="settle-item"><b>${payers[i].name}</b> â” çµ¦ â” <b>${receivers[j].name}</b> ï¼š <span style="font-size:20px; font-weight:900; color:var(--gold);">$${Math.round(amt)}</span></div>`);
        payers[i].amount -= amt; receivers[j].amount -= amt;
        if(payers[i].amount === 0) i++;
        if(receivers[j].amount === 0) j++;
    }
    
    document.getElementById('analyze-results').innerHTML = results.length > 0 ? results.join('') : "å¸³ç›®å·²å¹³è¡¡ï¼Œä¸éœ€è¦è½‰å¸³ã€‚";
}

// ä¸€éµæ­¸é›¶
async function clearAllData() {
    if(!confirm("âš ï¸ æ³¨æ„ï¼šé€™æœƒå°‡æ‰€æœ‰äººçš„ã€éŠæˆ²é¡ã€‘èˆ‡ã€é›œæ”¯å‚µå‹™ã€‘å…¨éƒ¨æ¸…ç©ºç‚º 0ã€‚ç¢ºå®šå—ï¼Ÿ")) return;
    for(let p of players) {
        await patch(p.id, { money: 0, debt: 0 });
    }
    alert("è³‡æ–™åº«å·²æ¸…é›¶ï¼");
    init();
}

async function patch(id, data) {
    return fetch(`${API_URL}/players?id=eq.${id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify(data) });
}

init();
</script>
</body>
</html>


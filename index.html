<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger v4.7 - è¨ºæ–·ç‰ˆ</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; }
        .card { background: var(--card); padding: 18px; border-radius: 18px; margin-bottom: 12px; border: 1px solid var(--border); }
        h2 { color: var(--gold); margin: 0 0 12px 0; font-size: 16px; border-left: 4px solid var(--gold); padding-left: 10px; }
        select, input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .share-btn { padding: 12px 5px; background: #161b22; border: 1px solid #444; border-radius: 8px; text-align: center; font-size: 12px; cursor: pointer; color: var(--gray); transition: 0.2s; }
        .share-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(0, 210, 255, 0.1); font-weight: bold; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px; }
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        #note-preview { font-size: 12px; color: #00ff00; background: #000; padding: 10px; border-radius: 8px; white-space: pre-wrap; word-break: break-all; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="card">
    <h2>1. è®€å–æ­·å²çµå–® (å°‹æ‰¾å…§å®¹ä¸­...)</h2>
    <select id="history-select" onchange="previewNote()"></select>
    <div style="font-size:11px; color:var(--gray); margin-bottom:5px;">é è¦½å…§å®¹ï¼š</div>
    <div id="note-preview">è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡æ™‚é–“</div>
    <button class="btn-main" style="background:var(--gold); color:#000; margin-top:10px;" onclick="importHistory()">åŒ¯å…¥é¸ä¸­å…§å®¹</button>
</div>

<div class="card">
    <h2>2. ç”Ÿæ´»åˆ†æ”¤èˆ‡åˆ†æ</h2>
    <div id="share-grid" class="share-grid"></div>
    <input type="number" id="pay-amt" placeholder="è¼¸å…¥ç¸½é‡‘é¡">
    <button class="btn-main" style="background:var(--green); color:#000;" onclick="submitExpense()">ç¢ºèªåˆ†æ”¤</button>
</div>

<div class="card">
    <h2>3. çµç®—çµæœ</h2>
    <div id="ledger-list"></div>
    <button class="btn-main" style="background:var(--blue); color:#000;" onclick="analyzeMoney()">ğŸ”„ åŸ·è¡Œè‡ªå‹•åˆ†é…</button>
    <div id="analyze-results" style="margin-top:15px;"></div>
</div>

<button class="btn-main" style="background:none; border:1px solid var(--red); color:var(--red); margin-top:20px; margin-bottom:50px;" onclick="clearAllData()">ğŸ§¹ çµå¸³å®Œæˆï¼šä¸€éµæ­¸é›¶</button>

<script>
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let players = [], historyList = [];

async function init() {
    try {
        const [pRes, hRes] = await Promise.all([
            fetch(`${API_URL}/players?select=*`, { headers: HEADERS }),
            fetch(`${API_URL}/history?select=*&order=created_at.desc&limit=20`, { headers: HEADERS })
        ]);
        players = await pRes.json();
        historyList = await hRes.json();
        renderUI();
    } catch (e) { alert("è®€å–å¤±æ•—"); }
}

function renderUI() {
    const hSelect = document.getElementById('history-select');
    hSelect.innerHTML = '<option value="">-- é¸æ“‡ç´€éŒ„æ™‚é–“ --</option>' + 
        historyList.map((h, i) => {
            // è‡ªå‹•åµæ¸¬å“ªä¸€å€‹æ¬„ä½æœ‰å…§å®¹
            const content = h.note || h.summary || h.content || h.memo || "ç„¡å…§å®¹";
            const time = new Date(h.created_at).toLocaleString();
            return `<option value="${i}">${time} (${content.substring(0,10)}...)</option>`;
        }).join('');

    document.getElementById('share-grid').innerHTML = players.map(p => 
        `<div class="share-btn" data-id="${p.id}" onclick="this.classList.toggle('active')">${p.name.replace('OFF_','')}</div>`).join('');

    document.getElementById('ledger-list').innerHTML = players.filter(p => Math.abs(p.debt||0)>0.1).map(p => 
        `<div class="ledger-row"><span>${p.name.replace('OFF_','')}</span><b>${Math.round(p.debt)}</b></div>`).join('');
}

function previewNote() {
    const idx = document.getElementById('history-select').value;
    if(idx === "") return;
    const item = historyList[idx];
    // é¡¯ç¤ºæ‰€æœ‰å¯èƒ½çš„å…§å®¹æ¬„ä½ï¼Œå¹«ä½ æ‰¾åˆ°å®ƒåœ¨å“ª
    const display = item.note || item.summary || item.content || "æ‰¾ä¸åˆ°å…§å®¹æ¬„ä½ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«æ¬„ä½åç¨±ã€‚";
    document.getElementById('note-preview').innerText = display;
}

async function importHistory() {
    const idx = document.getElementById('history-select').value;
    const note = historyList[idx].note || historyList[idx].summary || historyList[idx].content;
    if(!note || note === "ç„¡å…§å®¹") return alert("æ­¤ç­†ç´€éŒ„ç„¡æœ‰æ•ˆå…§å®¹");

    const parts = note.split('|');
    for(let pStr of parts) {
        const pair = pStr.split(':');
        if(pair.length < 2) continue;
        const n = pair[0].trim();
        const a = parseFloat(pair[1].trim());
        const target = players.find(p => p.name.includes(n));
        if(target) await patch(target.id, { debt: (target.debt || 0) + a });
    }
    alert("åŒ¯å…¥æˆåŠŸ");
    init();
}

// åˆ†æ”¤èˆ‡åˆ†æé‚è¼¯ (ä¿æŒä¸è®Š)
async function submitExpense() {
    const amt = parseFloat(document.getElementById('pay-amt').value);
    const selected = Array.from(document.querySelectorAll('.share-btn.active')).map(el => el.dataset.id);
    if(!amt || selected.length === 0) return alert("è«‹è¼¸å…¥é‡‘é¡ä¸¦é¸äºº");
    const per = amt / selected.length;
    for(let p of players) {
        let diff = 0; if(selected.includes(String(p.id))) diff -= per;
        if(Math.abs(diff)>0.1) await patch(p.id, { debt: (p.debt||0)+diff });
    }
    init();
}

function analyzeMoney() {
    let d = players.filter(p => Math.abs(p.debt||0)>0.5).map(p => ({name:p.name.replace('OFF_',''), amount:Math.round(p.debt)}));
    let r = d.filter(x => x.amount > 0).sort((a,b)=>b.amount-a.amount);
    let p = d.filter(x => x.amount < 0).map(x => ({...x, amount:Math.abs(x.amount)})).sort((a,b)=>b.amount-a.amount);
    let res = [], i=0, j=0;
    while(i<p.length && j<r.length) {
        let amt = Math.min(p[i].amount, r[j].amount);
        res.push(`<div style="padding:10px; border-bottom:1px solid #333;"><b>${p[i].name}</b> â” çµ¦ â” <b>${r[j].name}</b> : $${amt}</div>`);
        p[i].amount-=amt; r[j].amount-=amt;
        if(p[i].amount===0) i++; if(r[j].amount===0) j++;
    }
    document.getElementById('analyze-results').innerHTML = res.join('');
}

async function clearAllData() {
    if(!confirm("ç¢ºå®šæ­¸é›¶è³‡æ–™åº«ï¼Ÿ")) return;
    for(let p of players) await patch(p.id, { money:0, debt:0 });
    init();
}

async function patch(id, data) {
    return fetch(`${API_URL}/players?id=eq.${id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify(data) });
}

init();
</script>
</body>
</html>


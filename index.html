<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger - æ·±åº¦è¨ºæ–·ç‰ˆ</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: sans-serif; background: var(--bg); color: #fff; padding: 15px; }
        .card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 12px; border: 1px solid var(--border); }
        select { width: 100%; padding: 12px; background: #000; color: #fff; border-radius: 10px; margin-bottom: 10px; }
        #debug-box { font-family: monospace; font-size: 11px; color: #00ff00; background: #000; padding: 10px; border-radius: 8px; white-space: pre-wrap; word-break: break-all; border: 1px solid #444; min-height: 100px; }
        .btn-main { width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color:var(--gold); font-size:16px;">ğŸ” ç¬¬ä¸€æ­¥ï¼šæ‰¾å‡ºçµå–®å…§å®¹åœ¨å“ª</h2>
    <label style="font-size:12px; color:var(--gray);">é¸æ“‡æ™‚é–“ï¼ˆçœ‹ä¸‹æ–¹ç¶ å­—å‡ºç¾ä»€éº¼ï¼‰ï¼š</label>
    <select id="history-select" onchange="inspectData()"></select>
    <div id="debug-box">é€™è£¡æœƒé¡¯ç¤ºè³‡æ–™åº«çš„åŸå§‹å…§å®¹...</div>
</div>

<div class="card" id="import-section" style="display:none;">
    <h2 style="color:var(--green); font-size:16px;">ğŸ“¥ ç¬¬äºŒæ­¥ï¼šå…§å®¹ç¢ºèªç„¡èª¤</h2>
    <p style="font-size:12px;">å¦‚æœä¸Šæ–¹ç¶ å­—æœ‰çœ‹åˆ°ã€Œç§‰è»’:497...ã€ï¼Œè«‹é»æ“Šä¸‹æ–¹ï¼š</p>
    <button class="btn-main" style="background:var(--gold); color:#000;" onclick="doImport()">åŒ¯å…¥æ­¤å…§å®¹åˆ°å‚µå‹™</button>
</div>

<script>
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json' };

let players = [], historyList = [];
let targetKey = ""; // è‡ªå‹•åµæ¸¬åˆ°çš„æ¬„ä½ Key

async function init() {
    try {
        const [pRes, hRes] = await Promise.all([
            fetch(`${API_URL}/players?select=*`, { headers: HEADERS }),
            fetch(`${API_URL}/history?select=*&order=created_at.desc&limit=10`, { headers: HEADERS })
        ]);
        players = await pRes.json();
        historyList = await hRes.json();
        
        const hSelect = document.getElementById('history-select');
        hSelect.innerHTML = '<option value="">-- é¸æ“‡ç´€éŒ„ --</option>' + 
            historyList.map((h, i) => `<option value="${i}">${new Date(h.created_at).toLocaleString()}</option>`).join('');
    } catch (e) { alert("é€£ç·šå¤±æ•—"); }
}

function inspectData() {
    const idx = document.getElementById('history-select').value;
    const debugBox = document.getElementById('debug-box');
    const importSection = document.getElementById('import-section');
    
    if(idx === "") {
        debugBox.innerText = "è«‹å…ˆé¸æ“‡æ™‚é–“";
        importSection.style.display = "none";
        return;
    }

    const item = historyList[idx];
    // å°‡æ•´ç­†è³‡æ–™è½‰æˆ JSON å­—ä¸²é¡¯ç¤ºå‡ºä¾†
    debugBox.innerText = JSON.stringify(item, null, 2);

    // è‡ªå‹•æƒæå“ªä¸€å€‹æ¬„ä½åŒ…å« "|" æˆ– ":" (çµå–®æ ¼å¼)
    targetKey = "";
    for (let key in item) {
        if (typeof item[key] === 'string' && item[key].includes(':') && item[key].includes('|')) {
            targetKey = key;
            break;
        }
    }

    if(targetKey) {
        importSection.style.display = "block";
        debugBox.innerHTML += `\n\nâœ… åµæ¸¬åˆ°çµå–®æ•¸æ“šåœ¨æ¬„ä½ï¼š[${targetKey}]`;
    } else {
        importSection.style.display = "none";
        debugBox.innerHTML += `\n\nâŒ æ‰¾ä¸åˆ°åŒ…å«ã€Œ:ã€å’Œã€Œ|ã€çš„çµå–®æ•¸æ“šã€‚è«‹æª¢æŸ¥éŠæˆ²ç¨‹å¼æ˜¯å¦æ­£ç¢ºé€å–®ã€‚`;
    }
}

async function doImport() {
    const idx = document.getElementById('history-select').value;
    const note = historyList[idx][targetKey];
    
    const parts = note.split('|');
    for(let pStr of parts) {
        const pair = pStr.split(':');
        if(pair.length < 2) continue;
        const n = pair[0].trim();
        const a = parseFloat(pair[1].trim());
        const target = players.find(p => p.name.includes(n));
        if(target) {
            await fetch(`${API_URL}/players?id=eq.${target.id}`, {
                method: 'PATCH',
                headers: HEADERS,
                body: JSON.stringify({ debt: (target.debt || 0) + a })
            });
        }
    }
    alert("åŒ¯å…¥æˆåŠŸï¼");
    location.reload();
}

init();
</script>
</body>
</html>


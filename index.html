<script>
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json' };

async function load() {
    try {
        const t = Date.now();
        // 1. å…ˆæŠ“æœ€ç©©å®šçš„ Playersï¼Œå¦‚æœé€™æ­¥å°±éŒ¯ï¼Œä»£è¡¨é€£ç·šç¶²å€æˆ– KEY éŒ¯äº†
        const pRes = await fetch(`${API_URL}/players?select=*&order=name&t=${t}`, { headers: HEADERS });
        if (!pRes.ok) throw new Error("API é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ– KEY");
        players = await pRes.json();

        // 2. å˜—è©¦æŠ“å–å…¶ä»–è¡¨ï¼Œå¤±æ•—ä¹Ÿæ²’é—œä¿‚
        try {
            const hRes = await fetch(`${API_URL}/history?select=*&order=created_at.desc&t=${t}`, { headers: HEADERS });
            const lRes = await fetch(`${API_URL}/ledger_logs?select=*&order=created_at.desc&t=${t}`, { headers: HEADERS });
            
            const allH = await hRes.json();
            officialLogs = lRes.ok ? await lRes.json() : []; // å¦‚æœè¡¨ä¸å­˜åœ¨å°±çµ¦ç©ºé™£åˆ—
            
            const clearPoint = allH.find(h => h.description.includes("ğŸ§¹ å…¨é«”æ­¸é›¶"));
            if(clearPoint) lastClearTime = clearPoint.created_at;
            historyInbox = allH.filter(h => h.description && h.description.includes(':') && !h.description.includes('[å·²è™•ç†]'));
        } catch (innerE) {
            console.log("éƒ¨åˆ†è³‡æ–™è¡¨è®€å–è·³é");
        }

        renderUI();
    } catch (e) { 
        alert("ğŸš¨ é€£ç·šè¨ºæ–·ï¼š\n" + e.message + "\n\nè«‹ç¢ºèªæ‰‹æ©Ÿç¶²è·¯æ˜¯å¦æ­£å¸¸ã€‚"); 
    }
}
</script>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger v2.1 - æ™ºæ…§è²¡å‹™ä¸­å¿ƒ</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; line-height: 1.5; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid var(--border); }
        h2 { color: var(--gold); margin-top: 0; font-size: 18px; display: flex; align-items: center; justify-content: space-between; }
        
        /* è¡¨å–®æ¨£å¼ */
        select, input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .share-btn { padding: 10px 5px; background: #161b22; border: 1px solid #444; border-radius: 8px; text-align: center; font-size: 12px; cursor: pointer; color: var(--gray); }
        .share-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(255, 165, 2, 0.1); font-weight: bold; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
        .player-info b { font-size: 17px; }
        .game-tag { font-size: 11px; color: var(--gray); background: #000; padding: 2px 6px; border-radius: 4px; }
        .debt-val { font-size: 18px; font-weight: bold; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-add { width: 100%; padding: 16px; background: var(--green); color: #000; border: none; border-radius: 12px; font-weight: 900; font-size: 16px; }
        .btn-calc { width: 100%; padding: 16px; background: var(--blue); color: #000; border: none; border-radius: 12px; font-weight: 900; font-size: 16px; margin-top: 10px; }
        .btn-merge { background: none; border: 1px solid var(--blue); color: var(--blue); padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; margin-top: 5px; }

        /* çµç®—çµæœæ¨£å¼ */
        .settle-box { background: rgba(46, 213, 115, 0.05); border: 2px dashed var(--green); padding: 15px; border-radius: 15px; margin-top: 15px; }
        .settle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .arrow { color: var(--gold); font-size: 12px; }
        .hidden { display: none; }
        .off-player { opacity: 0.6; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ’¸ æ–°å¢åˆ†æ”¤æ”¯å‡º</h2>
    <label style="font-size: 12px; color: var(--gray);">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</label>
    <select id="payer-id"></select>
    
    <label style="font-size: 12px; color: var(--gray);">ç¸½é‡‘é¡</label>
    <input type="number" id="pay-amt" placeholder="ä¾‹å¦‚ï¼š1200" inputmode="decimal">
    
    <label style="font-size: 12px; color: var(--gray); display: block; margin-bottom: 8px;">åƒèˆ‡åˆ†æ”¤æˆå“¡ (åƒ…é™åœ¨ç·š)</label>
    <div id="share-grid" class="share-grid"></div>
    
    <button class="btn-add" onclick="submitLedger()">âœ… ç¢ºèªè¨˜å¸³</button>
</div>

<div class="card">
    <h2>ğŸ“Š è²¡å‹™æ¸…ç®—æ¸…å–®</h2>
    <div id="ledger-list"></div>
    
    <button class="btn-calc" onclick="calculateSettlements()">ğŸ”„ ç”Ÿæˆé‚„éŒ¢å»ºè­° (é›»è…¦æ’®åˆ)</button>
    
    <div id="settle-area" class="hidden">
        <div class="settle-box">
            <h3 style="margin:0 0 10px 0; font-size:16px; color:var(--green); text-align:center;">ğŸ’¡ æœ€ä½³é‚„éŒ¢è·¯å¾‘</h3>
            <div id="settle-results"></div>
            <button onclick="copySettlement()" style="width:100%; background:none; border:1px solid var(--gray); color:var(--gray); margin-top:10px; padding:8px; border-radius:8px; font-size:12px;">è¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿</button>
        </div>
    </div>
</div>

<script>
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let players = [];

// åˆå§‹åŒ–ï¼šæŠ“å–æ•¸æ“š
async function fetchData() {
    try {
        const res = await fetch(`${API_URL}/players?select=*&order=name`, { headers: HEADERS });
        players = await res.json();
        render();
    } catch (e) { console.error("æŠ“å–å¤±æ•—", e); }
}

function render() {
    // 1. ç¯©é¸åœ¨ç·šæˆå“¡ (ç”¨æ–¼è¨˜å¸³é¸æ“‡)
    const online = players.filter(p => !p.name.startsWith('OFF_'));
    
    document.getElementById('payer-id').innerHTML = online.map(p => 
        `<option value="${p.id}">${p.name}</option>`).join('');
    
    document.getElementById('share-grid').innerHTML = online.map(p => 
        `<div class="share-btn" data-id="${p.id}" onclick="this.classList.toggle('active')">${p.name}</div>`).join('');

    // 2. é¡¯ç¤ºåå–® (åŒ…å«åœ¨ç·šè€…ï¼Œæˆ–æ˜¯æœ‰éŒ¢æ²’æ¸…å®Œçš„ä¸‹ç·šè€…)
    const listDisplay = players.filter(p => {
        const isOnline = !p.name.startsWith('OFF_');
        const hasMoney = Math.abs(p.money || 0) > 0.1;
        const hasDebt = Math.abs(p.debt || 0) > 0.1;
        return isOnline || hasMoney || hasDebt;
    });

    document.getElementById('ledger-list').innerHTML = listDisplay.map(p => {
        const d = Math.round(p.debt || 0);
        const g = Math.round(p.money || 0);
        const isOff = p.name.startsWith('OFF_');
        const displayName = isOff ? 'ğŸ’¤ ' + p.name.replace('OFF_', '') : p.name;

        return `
            <div class="ledger-row ${isOff ? 'off-player' : ''}">
                <div class="player-info">
                    <b>${displayName}</b><br>
                    <span class="game-tag">ğŸ® éŠæˆ²é¡: ${g}</span>
                </div>
                <div style="text-align:right">
                    <div class="debt-val" style="color:${d >= 0 ? 'var(--green)' : 'var(--red)'}">${d >= 0 ? '+'+d : d}</div>
                    <button class="btn-merge" onclick="mergeFromGame(${p.id})">ğŸ“¥ ä½µå…¥</button>
                </div>
            </div>
        `;
    }).join('');
}

// è¨˜å¸³æäº¤
async function submitLedger() {
    const payerId = document.getElementById('payer-id').value;
    const amount = parseFloat(document.getElementById('pay-amt').value);
    const selected = Array.from(document.querySelectorAll('.share-btn.active')).map(el => el.dataset.id);

    if (!amount || selected.length === 0) return alert("è«‹è¼¸å…¥é‡‘é¡ä¸¦é¸æ“‡åˆ†æ”¤äºº");

    const perShare = amount / selected.length;
    
    for (let p of players) {
        let diff = 0;
        if (p.id == payerId) diff += amount;
        if (selected.includes(String(p.id))) diff -= perShare;

        if (Math.abs(diff) > 0.1) {
            await fetch(`${API_URL}/players?id=eq.${p.id}`, {
                method: 'PATCH',
                headers: HEADERS,
                body: JSON.stringify({ debt: (p.debt || 0) + diff })
            });
        }
    }
    
    document.getElementById('pay-amt').value = '';
    alert("è¨˜å¸³æˆåŠŸï¼");
    fetchData();
}

// ä½µå…¥éŠæˆ²é‡‘é¡
async function mergeFromGame(id) {
    const p = players.find(x => x.id === id);
    const cleanName = p.name.replace('OFF_', '');
    if (confirm(`ç¢ºå®šå°‡ ${cleanName} çš„éŠæˆ²é‡‘é¡ (${p.money}) ä½µå…¥ç”Ÿæ´»å‚µå‹™ï¼Ÿ\n(éŠæˆ²é¡å°‡æ­¸é›¶)`)) {
        await fetch(`${API_URL}/players?id=eq.${id}`, {
            method: 'PATCH',
            headers: HEADERS,
            body: JSON.stringify({ 
                debt: (p.debt || 0) + (p.money || 0),
                money: 0 
            })
        });
        fetchData();
    }
}

// æ ¸å¿ƒï¼šçµç®—æ¼”ç®—æ³• (é›»è…¦æç¤ºèª°çµ¦èª°éŒ¢)
function calculateSettlements() {
    // æŠ“å–æ‰€æœ‰æœ‰é¤˜é¡çš„äººï¼Œä¸è«–åœ¨ç·šèˆ‡å¦
    let debtors = players
        .filter(p => Math.abs(p.debt || 0) > 0.5)
        .map(p => ({ 
            name: p.name.replace('OFF_', ''), 
            amount: Math.round(p.debt || 0) 
        }));

    let receivers = debtors.filter(d => d.amount > 0).sort((a, b) => b.amount - a.amount);
    let payers = debtors.filter(d => d.amount < 0).map(d => ({ ...d, amount: Math.abs(d.amount) })).sort((a, b) => b.amount - a.amount);

    let result = [];
    let i = 0, j = 0;

    while (i < payers.length && j < receivers.length) {
        let payAmt = Math.min(payers[i].amount, receivers[j].amount);
        result.push({ from: payers[i].name, to: receivers[j].name, amount: payAmt });
        
        payers[i].amount -= payAmt;
        receivers[j].amount -= payAmt;

        if (payers[i].amount === 0) i++;
        if (receivers[j].amount === 0) j++;
    }

    const area = document.getElementById('settle-area');
    const resDiv = document.getElementById('settle-results');
    area.classList.remove('hidden');

    if (result.length === 0) {
        resDiv.innerHTML = "<div style='text-align:center; color:var(--gray);'>å¸³å‹™å·²å…©æ¸…ï¼</div>";
    } else {
        resDiv.innerHTML = result.map(r => `
            <div class="settle-row">
                <span style="color:var(--red); font-weight:bold;">${r.from}</span>
                <span class="arrow">â” çµ¦ â”</span>
                <span style="color:var(--green); font-weight:bold;">${r.to}</span>
                <span style="font-weight:900; font-size:18px;">$${Math.round(r.amount)}</span>
            </div>
        `).join('');
    }
}

// è¼”åŠ©ï¼šè¤‡è£½çµæœ
function copySettlement() {
    const rows = document.querySelectorAll('.settle-row');
    let text = "ğŸ“Š ELITE çµç®—å»ºè­°ï¼š\n";
    rows.forEach(row => {
        const spans = row.querySelectorAll('span');
        text += `${spans[0].innerText} â” çµ¦ ${spans[2].innerText} ï¼š $${spans[3].innerText}\n`;
    });
    navigator.clipboard.writeText(text);
    alert("å·²è¤‡è£½çµç®—å…§å®¹ï¼");
}

fetchData();
</script>
</body>
</html>


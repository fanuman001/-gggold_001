<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger v3.0</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid var(--border); }
        h2 { color: var(--gold); margin: 0 0 15px 0; font-size: 18px; }
        
        /* è¡¨å–® */
        select, input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .share-btn { padding: 10px 5px; background: #161b22; border: 1px solid #444; border-radius: 8px; text-align: center; font-size: 12px; cursor: pointer; color: var(--gray); }
        .share-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(0, 210, 255, 0.1); }
        .share-btn.is-off { border-style: dashed; } /* æ¨™è¨˜ä¸‹ç·šè€… */

        /* åˆ—è¡¨ */
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
        .debt-val { font-size: 18px; font-weight: bold; }
        
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 900; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-merge { background: none; border: 1px solid var(--blue); color: var(--blue); padding: 4px 8px; border-radius: 6px; font-size: 11px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ’¸ æ–°å¢åˆ†æ”¤ (å«ä¸‹ç·šæˆå“¡)</h2>
    <select id="payer-id"></select>
    <input type="number" id="pay-amt" placeholder="è¼¸å…¥ç¸½é‡‘é¡" inputmode="decimal">
    <div style="font-size:12px; color:var(--gray); margin-bottom:8px;">é¸æ“‡åˆ†æ”¤äºº (è™›ç·šç‚ºä¸‹ç·šè€…)ï¼š</div>
    <div id="share-grid" class="share-grid"></div>
    <button class="btn-main" style="background:var(--green); color:#000;" onclick="submitLedger()">âœ… ç¢ºèªè¨˜å¸³</button>
</div>

<div class="card">
    <h2>ğŸ“Š è²¡å‹™æ¸…å–®</h2>
    <div id="ledger-list"></div>
    <button class="btn-main" style="background:var(--blue); color:#000;" onclick="calculateSettlements()">ğŸ”„ ç”Ÿæˆé‚„éŒ¢å»ºè­°</button>
    
    <div id="settle-area" class="hidden" style="margin-top:15px; border-top:1px solid #444; padding-top:15px;">
        <div id="settle-results"></div>
    </div>
</div>

<div class="card" style="border-color: var(--red);">
    <h2 style="color:var(--red);">âš ï¸ å±éšªå€åŸŸ</h2>
    <p style="font-size:12px; color:var(--gray);">çµç®—å®Œæˆä¸¦ä»˜æ¸…éŒ¢å¾Œï¼ŒæŒ‰æ­¤æŒ‰éˆ•å°‡æ‰€æœ‰äººçš„ã€ŒéŠæˆ²é¡ã€èˆ‡ã€Œé›œæ”¯ã€æ­¸é›¶ã€‚</p>
    <button class="btn-main" style="background:none; border:1px solid var(--red); color:var(--red);" onclick="clearAllData()">ğŸ§¹ ä¸€éµçµæ¸…æ‰€æœ‰å¸³å–®</button>
</div>

<script>
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let players = [];

async function fetchData() {
    const res = await fetch(`${API_URL}/players?select=*&order=name`, { headers: HEADERS });
    players = await res.json();
    render();
}

function render() {
    // æ¸²æŸ“é¸æ“‡å€ï¼šé¡¯ç¤ºæ‰€æœ‰äººï¼Œä½†ç”¨è™›ç·šå€åˆ†ä¸‹ç·š
    document.getElementById('payer-id').innerHTML = players.map(p => 
        `<option value="${p.id}">${p.name.replace('OFF_','(ğŸ’¤)')}</option>`).join('');
    
    document.getElementById('share-grid').innerHTML = players.map(p => {
        const isOff = p.name.startsWith('OFF_');
        return `<div class="share-btn ${isOff?'is-off':''}" data-id="${p.id}" onclick="this.classList.toggle('active')">
            ${p.name.replace('OFF_','')}
        </div>`}).join('');

    // æ¸²æŸ“æ¸…å–®ï¼šé¡¯ç¤ºæ‰€æœ‰ã€Œæœ‰å¸³ã€çš„äºº
    const hasAccount = players.filter(p => Math.abs(p.money || 0) > 0.1 || Math.abs(p.debt || 0) > 0.1 || !p.name.startsWith('OFF_'));
    
    document.getElementById('ledger-list').innerHTML = hasAccount.map(p => {
        const d = Math.round(p.debt || 0);
        const g = Math.round(p.money || 0);
        const name = p.name.replace('OFF_', 'ğŸ’¤ ');
        return `
            <div class="ledger-row" style="${p.name.startsWith('OFF_')?'opacity:0.6':''}">
                <div>
                    <b>${name}</b><br>
                    <span style="font-size:11px; color:var(--gray);">ğŸ® éŠæˆ²ç¢ºå®šçµå–®: ${g}</span>
                </div>
                <div style="text-align:right">
                    <div class="debt-val" style="color:${d>=0?'var(--green)':'var(--red)'}">${d>=0?'+'+d:d}</div>
                    <button class="btn-merge" onclick="mergeFromGame(${p.id})">ğŸ“¥ ä½µå…¥</button>
                </div>
            </div>
        `;
    }).join('');
}

// è¨˜å¸³ï¼šæ”¯æŒæ‰€æœ‰äººåˆ†æ”¤
async function submitLedger() {
    const pId = document.getElementById('payer-id').value;
    const amt = parseFloat(document.getElementById('pay-amt').value);
    const selected = Array.from(document.querySelectorAll('.share-btn.active')).map(el => el.dataset.id);
    if(!amt || selected.length === 0) return alert("è«‹å¡«å¯«é‡‘é¡èˆ‡åˆ†æ”¤äºº");
    const per = amt / selected.length;
    for(let p of players) {
        let diff = 0;
        if(p.id == pId) diff += amt;
        if(selected.includes(String(p.id))) diff -= per;
        if(Math.abs(diff) > 0.1) await patch(p.id, { debt: (p.debt || 0) + diff });
    }
    document.getElementById('pay-amt').value = '';
    fetchData();
}

// ä¸€éµçµæ¸… (æ­¸é›¶)
async function clearAllData() {
    if(!confirm("ç¢ºå®šè¦å°‡å…¨é«”æˆå“¡çš„éŠæˆ²é¡èˆ‡é›œæ”¯æ­¸é›¶å—ï¼Ÿæ­¤å‹•ä½œä¸å¯æ’¤éŠ·ã€‚")) return;
    for(let p of players) {
        if(p.money !== 0 || p.debt !== 0) {
            await patch(p.id, { money: 0, debt: 0 });
        }
    }
    alert("å…¨å“¡å¸³å–®å·²çµæ¸…æ­¸é›¶ï¼");
    fetchData();
}

async function mergeFromGame(id) {
    const p = players.find(x => x.id === id);
    await patch(id, { debt: (p.debt || 0) + (p.money || 0), money: 0 });
    fetchData();
}

async function patch(id, data) {
    return fetch(`${API_URL}/players?id=eq.${id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify(data) });
}

// æ¼”ç®—æ³•éƒ¨åˆ†ä¿æŒåŸæœ¬é‚è¼¯...
function calculateSettlements() {
    let debtors = players.filter(p => Math.abs(p.debt || 0) > 0.5).map(p => ({ name: p.name.replace('OFF_',''), amount: Math.round(p.debt || 0) }));
    let res = []; // (æ¼”ç®—æ³•çœç•¥ï¼ŒåŒ v2.1 ç‰ˆ)
    // ...
    document.getElementById('settle-area').classList.remove('hidden');
    // ...
}

fetchData();
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger v4.0 - è¨‚å–®å°å…¥ç‰ˆ</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid var(--border); }
        h2 { color: var(--gold); margin: 0 0 15px 0; font-size: 18px; }
        select, input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .share-btn { padding: 10px 5px; background: #161b22; border: 1px solid #444; border-radius: 8px; text-align: center; font-size: 11px; cursor: pointer; color: var(--gray); }
        .share-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(0, 210, 255, 0.1); }
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 900; font-size: 16px; cursor: pointer; }
        .order-box { border: 1px dashed var(--gold); padding: 10px; border-radius: 10px; margin-bottom: 15px; background: rgba(255, 165, 2, 0.05); }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“¥ 1. è®€å–ç¢ºå®šçµå–®è¨‚å–®</h2>
    <div class="order-box">
        <label style="font-size:12px; color:var(--gray);">å¾æ­·å²ç´€éŒ„é¸æ“‡çµå–®ï¼š</label>
        <select id="history-select" onchange="previewOrder()"></select>
        <div id="order-preview" style="font-size:12px; color:var(--gold); min-height:20px;"></div>
        <button class="btn-main" style="background:var(--gold); color:#000; margin-top:10px; font-size:14px; padding:10px;" onclick="importOrder()">åŒ¯å…¥æ­¤å–®é‡‘é¡åˆ°å‚µå‹™</button>
    </div>
</div>

<div class="card">
    <h2>ğŸ’¸ 2. ç”Ÿæ´»é›œæ”¯åˆ†æ”¤</h2>
    <select id="payer-id"></select>
    <input type="number" id="pay-amt" placeholder="ç¸½é‡‘é¡" inputmode="decimal">
    <div id="share-grid" class="share-grid"></div>
    <button class="btn-main" style="background:var(--green); color:#000;" onclick="submitLedger()">âœ… ç¢ºèªè¨˜å¸³</button>
</div>

<div class="card">
    <h2>ğŸ“Š 3. æœ€çµ‚æ¸…ç®—å»ºè­°</h2>
    <div id="ledger-list"></div>
    <button class="btn-main" style="background:var(--blue); color:#000;" onclick="calculateSettlements()">ğŸ”„ æ™ºèƒ½åˆ†é…ï¼šèª°è©²çµ¦èª°éŒ¢</button>
    <div id="settle-results" style="margin-top:15px;"></div>
</div>

<button class="btn-main" style="background:none; border:1px solid var(--red); color:var(--red); margin-bottom:50px;" onclick="clearDatabase()">ğŸ§¹ çµå¸³å®Œæˆï¼šä¸€éµæ­¸é›¶è³‡æ–™åº«</button>

<script>
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let players = [], history = [];

async function init() {
    const [pRes, hRes] = await Promise.all([
        fetch(`${API_URL}/players?select=*`, { headers: HEADERS }),
        fetch(`${API_URL}/history?select=*&order=created_at.desc&limit=20`, { headers: HEADERS })
    ]);
    players = await pRes.json();
    history = await hRes.json();
    render();
}

function render() {
    // æ­·å²è¨‚å–®ä¸‹æ‹‰
    document.getElementById('history-select').innerHTML = '<option value="">è«‹é¸æ“‡ä¸€ç­†è¨‚å–®...</option>' + 
        history.map((h, i) => `<option value="${i}">${new Date(h.created_at).toLocaleString()} - ${h.note.substring(0,20)}...</option>`).join('');

    // å¢ŠéŒ¢äººé¸å–® (æ‰€æœ‰äºº)
    document.getElementById('payer-id').innerHTML = players.map(p => `<option value="${p.id}">${p.name.replace('OFF_','')}</option>`).join('');

    // åˆ†æ”¤äººé¸å–® (æ‰€æœ‰äºº)
    document.getElementById('share-grid').innerHTML = players.map(p => 
        `<div class="share-btn" data-id="${p.id}" onclick="this.classList.toggle('active')">${p.name.replace('OFF_','')}</div>`).join('');

    // ç¸½å¸³åˆ—è¡¨
    document.getElementById('ledger-list').innerHTML = players.filter(p => Math.abs(p.debt||0) > 0.1).map(p => `
        <div class="ledger-row">
            <span>${p.name.replace('OFF_','')}</span>
            <b style="color:${p.debt>=0?'var(--green)':'var(--red)'}">${Math.round(p.debt||0)}</b>
        </div>`).join('');
}

function previewOrder() {
    const idx = document.getElementById('history-select').value;
    if(idx==="") return;
    document.getElementById('order-preview').innerText = history[idx].note;
}

// æ ¸å¿ƒï¼šå¾æ­·å²è¨‚å–®è§£æä¸¦åŒ¯å…¥
async function importOrder() {
    const idx = document.getElementById('history-select').value;
    if(idx==="") return;
    const note = history[idx].note; // æ ¼å¼: "ç§‰è»’:497 | èªå©•:-502..."
    
    if(!confirm("ç¢ºå®šåŒ¯å…¥æ­¤è¨‚å–®é‡‘é¡ï¼Ÿé€™æœƒç›´æ¥å¢åŠ å„å“¡å‚µå‹™ã€‚")) return;

    const entries = note.split('|');
    for(let entry of entries) {
        const [rawName, rawAmt] = entry.split(':');
        if(!rawName || !rawAmt) continue;
        
        const name = rawName.trim();
        const amt = parseFloat(rawAmt.trim());
        
        // å°‹æ‰¾å°æ‡‰çƒå“¡ (å¿½ç•¥ OFF_)
        const player = players.find(p => p.name.replace('OFF_','') === name);
        if(player) {
            await patch(player.id, { debt: (player.debt || 0) + amt });
        }
    }
    alert("åŒ¯å…¥æˆåŠŸï¼");
    init();
}

async function submitLedger() {
    const payerId = document.getElementById('payer-id').value;
    const amt = parseFloat(document.getElementById('pay-amt').value);
    const selected = Array.from(document.querySelectorAll('.share-btn.active')).map(el => el.dataset.id);
    if(!amt || selected.length === 0) return;
    const per = amt / selected.length;
    for(let p of players) {
        let diff = 0;
        if(p.id == payerId) diff += amt;
        if(selected.includes(String(p.id))) diff -= per;
        if(Math.abs(diff)>0.1) await patch(p.id, { debt: (p.debt||0) + diff });
    }
    init();
}

function calculateSettlements() {
    let data = players.filter(p => Math.abs(p.debt||0) > 0.5).map(p => ({ name: p.name.replace('OFF_',''), amount: Math.round(p.debt) }));
    let res = [];
    let r = data.filter(d => d.amount > 0).sort((a,b) => b.amount - a.amount);
    let p = data.filter(d => d.amount < 0).map(d => ({...d, amount: Math.abs(d.amount)})).sort((a,b) => b.amount - a.amount);
    let i=0, j=0;
    while(i<p.length && j<r.length) {
        let amt = Math.min(p[i].amount, r[j].amount);
        res.push(`<div style="padding:10px; border-bottom:1px solid #333;"><b style="color:var(--red);">${p[i].name}</b> â” çµ¦ <b style="color:var(--green);">${r[j].name}</b> : <span style="font-size:18px;">$${Math.round(amt)}</span></div>`);
        p[i].amount -= amt; r[j].amount -= amt;
        if(p[i].amount === 0) i++; if(r[j].amount === 0) j++;
    }
    document.getElementById('settle-results').innerHTML = res.join('');
}

async function clearDatabase() {
    if(!confirm("ç¢ºå®šçµå¸³å®Œæˆï¼Ÿé€™å°‡æ¸…ç©ºæ‰€æœ‰æˆå“¡çš„éŠæˆ²é‡‘é¡èˆ‡å‚µå‹™ï¼")) return;
    for(let p of players) {
        await patch(p.id, { money: 0, debt: 0 });
    }
    alert("è³‡æ–™åº«å·²æ¸…é›¶ã€‚");
    init();
}

async function patch(id, data) {
    return fetch(`${API_URL}/players?id=eq.${id}`, { method: 'PATCH', headers: HEADERS, body: JSON.stringify(data) });
}

init();
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ledger - ç¨ç«‹è¨˜å¸³ä¸­å¿ƒ</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid var(--border); }
        h2 { color: var(--gold); margin-top: 0; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        
        /* è¨˜å¸³åˆ—è¡¨æ¨£å¼ */
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #333; }
        .money-box { text-align: right; }
        .game-val { font-size: 12px; color: var(--gray); }
        .debt-val { font-size: 18px; font-weight: bold; color: var(--white); }

        /* ä½µå…¥æŒ‰éˆ• */
        .btn-merge { background: rgba(0, 210, 255, 0.1); color: var(--blue); border: 1px solid var(--blue); padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .btn-merge:hover { background: var(--blue); color: #000; }

        .input-group { margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-top: 5px; box-sizing: border-box; }
        .btn-add { width: 100%; padding: 15px; background: var(--green); color: #000; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ’¸ æ–°å¢ç”Ÿæ´»é›œæ”¯</h2>
    <div class="input-group">
        <label>å¢Šæ¬¾äºº</label>
        <select id="payer-id"></select>
        <label style="display:block; margin-top:10px;">ç¸½é‡‘é¡</label>
        <input type="number" id="pay-amt" placeholder="è¼¸å…¥å¢Šä»˜é‡‘é¡">
        <label style="display:block; margin-top:10px;">åƒèˆ‡åˆ†æ”¤æˆå“¡ (å¯å¤šé¸)</label>
        <div id="share-grid" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:8px;"></div>
    </div>
    <button class="btn-add" onclick="submitLedger()">ç¢ºèªè¨˜å¸³</button>
</div>

<div class="card">
    <h2>ğŸ“Š è²¡å‹™ç¸½è¦½ (å«éŠæˆ²é¤˜é¡è®€å–)</h2>
    <div id="ledger-list"></div>
</div>

<script>
// --- åŒæ¨£é€£æ¥ä½ çš„ Supabase ---
const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let players = [];

async function fetchData() {
    const res = await fetch(`${API_URL}/players?select=*&order=name`, { headers: HEADERS });
    players = await res.json();
    render();
}

function render() {
    const on = players.filter(p => !p.name.startsWith('OFF_'));
    
    // æ¸²æŸ“ä¸‹æ‹‰é¸å–®
    document.getElementById('payer-id').innerHTML = on.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    
    // æ¸²æŸ“åˆ†æ”¤å‹¾é¸å€
    document.getElementById('share-grid').innerHTML = on.map(p => `
        <div class="share-btn" data-id="${p.id}" onclick="this.classList.toggle('active')" 
             style="padding:10px; background:#161b22; border:1px solid #444; border-radius:8px; text-align:center; font-size:12px; cursor:pointer;">
            ${p.name}
        </div>
    `).join('');

    // æ¸²æŸ“ä¸»åˆ—è¡¨
    document.getElementById('ledger-list').innerHTML = on.map(p => {
        const d = Math.round(p.debt || 0);
        const g = Math.round(p.money || 0);
        return `
            <div class="ledger-row">
                <div>
                    <b style="font-size:18px;">${p.name}</b><br>
                    <span class="game-val">ğŸ® éŠæˆ²é¤˜é¡: ${g >= 0 ? '+'+g : g}</span>
                </div>
                <div class="money-box">
                    <div class="debt-val" style="color:${d >= 0 ? 'var(--green)' : 'var(--red)'}">${d >= 0 ? '+'+d : d}</div>
                    <button class="btn-merge" onclick="mergeFromGame(${p.id})">ğŸ“¥ ä½µå…¥éŠæˆ²é‡‘é¡</button>
                </div>
            </div>
        `;
    }).join('');
}

// è¨˜å¸³é‚è¼¯
async function submitLedger() {
    const pId = document.getElementById('payer-id').value;
    const amt = parseFloat(document.getElementById('pay-amt').value);
    const selected = Array.from(document.querySelectorAll('.share-btn.active')).map(el => el.dataset.id);

    if(!amt || selected.length === 0) return alert("è«‹è¼¸å…¥é‡‘é¡ä¸¦é¸æ“‡åˆ†æ”¤äºº");

    const perShare = amt / selected.length;
    
    for (let p of players) {
        let diff = 0;
        if (p.id == pId) diff += amt;
        if (selected.includes(String(p.id))) diff -= perShare;
        
        if (diff !== 0) {
            await fetch(`${API_URL}/players?id=eq.${p.id}`, {
                method: 'PATCH',
                headers: HEADERS,
                body: JSON.stringify({ debt: (p.debt || 0) + diff })
            });
        }
    }
    alert("è¨˜å¸³æˆåŠŸï¼");
    fetchData();
}

// ä½µå…¥åŠŸèƒ½ï¼šè®€å–éŠæˆ²é‡‘é¡ï¼ŒåŠ åˆ°è¨˜å¸³å‚µå‹™ä¸­ï¼Œä¸¦å°‡éŠæˆ²å¹£æ¸…é›¶ï¼ˆæˆ–åä¹‹ï¼‰
async function mergeFromGame(id) {
    const p = players.find(x => x.id === id);
    if(p.money === 0) return alert("éŠæˆ²é¤˜é¡ç‚º 0ï¼Œç„¡éœ€ä½µå…¥");
    
    if(confirm(`ç¢ºå®šå°‡ ${p.name} çš„éŠæˆ²é‡‘é¡ (${p.money}) ä½µå…¥ç”Ÿæ´»è¨˜å¸³å—ï¼Ÿ\n(é€™æœƒå°‡éŠæˆ²é¤˜é¡æ­¸é›¶)`)) {
        await fetch(`${API_URL}/players?id=eq.${id}`, {
            method: 'PATCH',
            headers: HEADERS,
            body: JSON.stringify({ 
                debt: (p.debt || 0) + p.money,
                money: 0 
            })
        });
        fetchData();
    }
}

// åŠ å…¥ CSS å•Ÿå‹•æ¨£å¼
const style = document.createElement('style');
style.innerHTML = `.share-btn.active { border-color: var(--gold) !important; color: var(--gold); background: rgba(255,165,2,0.1) !important; }`;
document.head.appendChild(style);

fetchData();
</script>
</body>
</html>

